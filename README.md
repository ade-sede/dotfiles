# Dotfiles and NixOS Configuration

This repository contains my personal dotfiles and NixOS configuration. The goal is to provide a fully reproducible system setup with the absolute minimum of manual steps required.

## Getting Started

### Prerequisites

- Must be a NixOS machine or at the very least a system with Nix package manager installed
- Flakes must be enabled:

```bash
# For NixOS (Make sure repository contains no unstaged changes)
sudo mkdir -p /etc/nixos/
echo "{ nix.settings.experimental-features = [ 'nix-command' 'flakes' ]; }" | sudo tee /etc/nixos/flakes.nix

# If you have a legacy configuration in /etc/nixos/configuration.nix that imports this dotfiles repository,
# you can safely delete or backup that file as it's not used with flakes:
# sudo mv /etc/nixos/configuration.nix /etc/nixos/configuration.nix.backup

# For any other OS (macOS, Linux, etc.)
mkdir -p ~/.config/nix
echo "experimental-features = nix-command flakes" >> ~/.config/nix/nix.conf
```

### Installation

```bash
# Clone the repository
git clone https://github.com/ade-sede/dotfiles.git ~/.dotfiles
cd ~/.dotfiles

# NixOS with desktop
sudo nixos-rebuild switch --flake .#desktop --impure

# NixOS headless development server
sudo nixos-rebuild switch --flake .#development-server --impure

# Home Manager standalone (any non-NixOS system, granted nix is already installed)
nix run home-manager/master -- switch --flake .#ade-sede@home-manager-only
```

### Uploading security keys to GitHub

GPG & SSH keys are automatically generated by the home-manager configuration to get you started fast.
These services are defined in `home-manager/services/gpg-key-gen.nix` and `home-manager/services/ssh-key-gen.nix`.
However, these keys are not automatically uploaded to GitHub.

```fish
# List GPG keys to get the key ID
gpg --list-secret-keys --keyid-format=long

# Export GPG public key to a file
gpg --armor --export <KEY_ID> > gpg_github_key.asc

# Add the key to GitHub using GitHub CLI
gh gpg-key add gpg_github_key.asc

# Clean up
rm gpg_github_key.asc

# Add the SSH key to GitHub using GitHub CLI
gh auth login  # First authenticate with GitHub if needed
gh ssh-key add ~/.ssh/id_ed25519.pub -t "koala-devbox" # Should be pushed automatically if it exists when logging in for the first time
```

## Managing packages & configurations

### Installing new packages

Define the packages directly in nix:

- `home-manager/packages.nix` for user level packages
- `nixos/desktop.nix` for system level packages (preferred for GUI applications)

Once the configuration file is updated, rebuild with flakes:

```bash
# For system level packages
sudo nixos-rebuild switch --flake .#desktop --impure

# For home-manager standalone
nix run home-manager/master -- switch --flake .#ade-sede@home-manager-only
```

### Adding a NPM package through nix

```nix
{
  home.packages = with pkgs; [
    (pkgs.writeShellScriptBin "claude" ''
      exec ${pkgs.nodePackages.npm}/bin/npx @anthropic-ai/claude-code "$@"
    '')
  ];
}
```

This defines `claude` as a shell script that invokes `npx @anthropic-ai/claude-code`.

### Adding a Python package through nix

```nix
{
  home.packages = with pkgs; [
    python311Packages.requests
    python311Packages.numpy
    pythonPackages.pandas
  ];
}
```

### Adding additional configuration for all your software

You can either:

- add a new configuration file under `dotfiles/`
- inline the configuration in nix
- use nix specific configuration options, if the software is supported (example: fish)

Adding a new configuration file as a dotfile is recommended way.

### Adding a dotfile

To add a new dotfile to be managed by Home Manager:

1. Add the configuration file in `dotfiles/<software-name>`
2. Add a symlink entry in `home-manager/dotfiles.nix`
3. Apply changes with `home-manager switch`

### Backing up plasma configuration

This experiment failed, not currently able to manage plasma through _plasma-manager_.
It worked for window rules and desktop but was unstable for shortcuts, often crashing.
Store and manually import configurations in `dotfiles/KDE`.

## Managing NixOS Generations

### Listing Generations

List all available system generations:

```bash
sudo nix-env --list-generations --profile /nix/var/nix/profiles/system
```

### Deleting Old Generations

Remove old system generations to free up disk space:

```bash
# Self explanatory
sudo nix-collect-garbage --delete-older-than 14d

# Delete specific generations
sudo nix-env --delete-generations --profile /nix/var/nix/profiles/system 123 124 125

# Delete all generations except the current one
sudo nix-env --delete-generations --profile /nix/var/nix/profiles/system old
```

### Updating Boot Menu

After deleting old generations, update the boot menu to remove entries for deleted generations:

```bash
sudo nixos-rebuild boot
```

This removes old entries from the boot menu and reclaims disk space used by old system configurations.

## Development

### Pre-commit Hooks

This repository uses pre-commit hooks to ensure code quality. To set up:

```bash
pre-commit install
```

Hooks available:

- automated format of nix files with alejandra
- automated format of markdown files with mdformat
- gitleaks for secret scanning

### Repository Structure

```
.dotfiles/
├── flake.nix             # Main entry point
├── nixos/                # System configuration
├── home-manager/         # User configuration
├── scripts/              # Utility scripts 
├── dotfiles/             # Application configs
├── secrets/              # Secret files
├── KDE/                  # KDE Plasma configurations
├── profile-images/       # Profile pictures
└── wallpapers/           # Desktop wallpapers
```

### NixOS Configuration Structure

```
nixos/
├── configuration.nix    # NixOS entry point
├── bootloader.nix
├── hardware.nix
├── desktop.nix
├── networking.nix
├── audio.nix
├── programs.nix
├── services.nix
├── users.nix
├── home-manager.nix     # Imports the home-manager directory
├── locals.nix
├── nix.nix
├── secrets.nix
├── systemd.nix
├── virtualisation.nix
└── virtualisation/
    ├── containers.nix
    └── docker.nix

home-manager/
├── default.nix          # Home Manager entry point
├── home.nix
├── packages.nix
├── dotfiles.nix         # Symlinks to dotfiles in the repository
├── programs.nix
├── variables.nix
├── secrets.nix
├── services.nix
├── browsers.nix
├── desktop.nix
├── fish.nix
├── git.nix
├── tmux.nix
├── meme.nix
├── services/
└── scripts/
    └── tmux-switch-pane.sh
```
